#!/bin/bash

# Pokémon Summary Report Script
# Generates a CSV report with Pokémon data and calculates averages

# Directory containing Pokémon JSON files
DATA_DIR="pokemon_data"

# Output CSV file
CSV_FILE="pokemon_report.csv"

# Check if data directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: $DATA_DIR directory not found!"
    exit 1
fi

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$CSV_FILE"

# Arrays to store values for average calculation
declare -a heights
declare -a weights

# Process each JSON file
for json_file in "$DATA_DIR"/*.json; do
    if [ -f "$json_file" ]; then
        # Check if jq is available
        if command -v jq &> /dev/null; then
            # Use jq for extraction
            name=$(jq -r '.name' "$json_file" | sed 's/^./\u&/')
            height=$(jq -r '.height' "$json_file")
            weight=$(jq -r '.weight' "$json_file")
        else
            # Fallback to sed/awk/grep
            name=$(grep -o '"forms":\[{"name":"[^"]*"' "$json_file" | sed 's/.*"name":"//;s/".*//g' | sed 's/^./\U&/')
            height=$(grep -o '"height":[0-9]*' "$json_file" | sed 's/"height"://g')
            weight=$(grep -o '"weight":[0-9]*' "$json_file" | sed 's/"weight"://g')
        fi

        # Convert height from decimeters to meters
        height_m=$(echo "$height" | awk '{printf "%.1f", $1 / 10}')

        # Convert weight from hectograms to kilograms
        weight_kg=$(echo "$weight" | awk '{printf "%.1f", $1 / 10}')

        # Add to CSV
        echo "$name,$height_m,$weight_kg" >> "$CSV_FILE"

        # Store values for average calculation
        heights+=("$height")
        weights+=("$weight")
    fi
done

# Calculate averages using awk
if [ ${#heights[@]} -gt 0 ]; then
    # Create temporary file with heights
    printf '%s\n' "${heights[@]}" > /tmp/heights.tmp

    # Calculate average height (convert from decimeters to meters)
    avg_height=$(awk '{sum+=$1; count++} END {printf "%.2f", (sum/count)/10}' /tmp/heights.tmp)

    # Create temporary file with weights
    printf '%s\n' "${weights[@]}" > /tmp/weights.tmp

    # Calculate average weight (convert from hectograms to kilograms)
    avg_weight=$(awk '{sum+=$1; count++} END {printf "%.2f", (sum/count)/10}' /tmp/weights.tmp)

    # Clean up temporary files
    rm -f /tmp/heights.tmp /tmp/weights.tmp

    # Display the report
    echo "CSV Report generated at: $CSV_FILE"
    echo ""
    cat "$CSV_FILE"
    echo ""
    echo "Average Height: ${avg_height} m"
    echo "Average Weight: ${avg_weight} kg"
else
    echo "Error: No Pokémon data found in $DATA_DIR"
    exit 1
fi
